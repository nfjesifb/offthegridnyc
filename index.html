<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Off The Grid NYC</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a1a1a; /* Dark Charcoal */
      --secondary: #f8f8f8; /* Off-white */
      --accent: #1abc9c; /* Teal */
      --text: #333;
      --font: 'Poppins', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      color: var(--text);
      background: var(--secondary);
      line-height: 1.6;
      font-weight: 300; /* Lighter default weight */
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 1rem 2rem;
      text-align: center;
    }
    header h1 { font-size: 2.2rem; font-weight: 600; }
    main {
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    .map-container, .form-container {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border: none; /* Removed border */
      margin-bottom: 1.5rem; /* Increased spacing */
      overflow: hidden; /* Re-add for consistency with border-radius */
    }
    .map-container { height: 65vh; /* Adjust % as needed */ }
    #map { width: 100%; height: 100%; }
    .map-container h2, .form-container h2 {
      padding: 1rem 1.5rem;
      font-size: 1.5rem;
      color: #fff;
      background-color: var(--primary);
      border-bottom: none;
      margin-bottom: 0;
      font-weight: 400;
    }
    .form-container iframe {
      border: none;
      width: 100%;
      height: 1200px; /* Adjust height based on your form length */
    }
    #submit-section iframe {
      width: 100%;
      max-width: 800px; /* Optional: Limit width on large screens */
      height: 750px; /* Adjust based on typical form length */
      border: none;
      display: block;
      margin: 1rem auto 0 auto; /* Center the iframe */
    }
    footer {
      background: var(--primary);
      color: rgba(255, 255, 255, 0.8);
      text-align: center;
      padding: 1rem;
      font-size: 0.85rem;
      margin-top: 1.5rem;
      opacity: 0.9;
    }
    /* Info Window Styling */
    .popup-content {
      max-width: 410px;
      font-weight: 400; /* Slightly bolder for popup */
    }
    .popup-content h3 {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 10px;
    }
    .popup-content img {
      width: 100%;
      height: auto;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .popup-content p {
      margin-bottom: 10px;
    }
    .popup-content a {
      color: var(--accent);
      text-decoration: none;
    }
    .popup-content a:hover {
      text-decoration: underline;
      color: #16a085; /* Darker teal on hover */
    }
    /* Info Window Customization */
    .gm-style .gm-style-iw-c { /* Target the default white box */
      padding: 0 !important; /* Remove default padding */
      max-height: none !important; /* Allow our content div to control height */
    }
    .gm-style .gm-style-iw-d { /* Target the default content container */
      overflow: hidden !important; /* Prevent double scrollbars */
    }
    .info-window-content {
      padding: 12px 15px; /* Add our own padding */
      max-height: 300px; /* Set max height for the content area */
      overflow-y: auto; /* Enable vertical scroll IF content exceeds max-height */
      font-size: 0.9rem;
    }
    .info-window-content h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      color: var(--accent);
    }
    .info-window-content img {
      max-width: 100%;
      height: auto;
      max-height: 120px; /* Limit image height */
      display: block;
      margin: 0.5rem 0;
      border-radius: 4px;
    }
    .info-window-content p {
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    .info-window-content p:last-child {
      margin-bottom: 0;
    }
    .info-window-content a {
      color: var(--accent-dark);
      text-decoration: none;
      margin-right: 5px;
    }
    .info-window-content a:hover {
      text-decoration: underline;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBksh0YwSl7gekcaTX-_xRcBE-Me125rc&callback=initMap" async defer></script>
</head>
<body>
  <header>
    <h1>Off The Grid NYC</h1>
  </header>
  <main>
    <section class="map-container">
      <h2>Explore Verified Places</h2>
      <div id="map"></div>
      <!-- Info window content is generated dynamically in JS -->
    </section>
    <section class="form-container">
      <h2>Know a place that belongs here? Share!</h2>
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSf-3Fi0LTuKLsSUQvrr_uVkenJkpHBEO5bDQXM567_NW4U5Ag/viewform?embedded=true"></iframe>
    </section>
  </main>
  <footer>
    &copy; 2025 Off The Grid NYC
    <br>
    Explore all locations visually on the <a href="https://www.google.com/maps/d/edit?mid=1gl24kbeTNZ13SmaCbMsam2CYe8Ury7M&usp=sharing" target="_blank" rel="noopener noreferrer">Off The Grid NYC Google My Map</a>.
  </footer>

  <script>
    async function initMap() {
      const meta = await (await fetch('locations.json')).json();
      const locMap = Object.fromEntries(meta.map(x => [x.name, x]));
      const kmlText = await (await fetch('offthegridnyc.kml')).text();
      const kmlDoc = new DOMParser().parseFromString(kmlText, 'application/xml');
      const iconMap = {};
      kmlDoc.querySelectorAll('StyleMap[id]').forEach(sm => {
        const id = sm.getAttribute('id');
        let url = '';
        sm.querySelectorAll('Pair').forEach(pair => {
          if (pair.querySelector('key')?.textContent === 'normal') {
            const ref = pair.querySelector('styleUrl')?.textContent.slice(1);
            const se = kmlDoc.querySelector(`Style[id="${ref}"]`);
            const href = se?.querySelector('Icon > href')?.textContent;
            if (href) url = href;
          }
        });
        if (id && url) iconMap[id] = url;
      });
      // Custom Map Style (Silver Base)
      const mapStyle = [
        { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
        { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
        {
          featureType: "administrative.land_parcel",
          elementType: "labels.text.fill",
          stylers: [{ color: "#bdbdbd" }],
        },
        {
          featureType: "poi",
          elementType: "geometry",
          stylers: [{ color: "#eeeeee" }],
        },
        {
          featureType: "poi",
          elementType: "labels.text.fill",
          stylers: [{ color: "#757575" }],
        },
        { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
        {
          featureType: "poi.park",
          elementType: "labels.text.fill",
          stylers: [{ color: "#9e9e9e" }],
        },
        { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
        {
          featureType: "road.arterial",
          elementType: "labels.text.fill",
          stylers: [{ color: "#757575" }],
        },
        { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#dadada" }] },
        {
          featureType: "road.highway",
          elementType: "labels.text.fill",
          stylers: [{ color: "#616161" }],
        },
        {
          featureType: "road.local",
          elementType: "labels.text.fill",
          stylers: [{ color: "#9e9e9e" }],
        },
        { featureType: "transit.line", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
        {
          featureType: "transit.station",
          elementType: "geometry",
          stylers: [{ color: "#eeeeee" }],
        },
        { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
        {
          featureType: "water",
          elementType: "labels.text.fill",
          stylers: [{ color: "#9e9e9e" }],
        },
      ];

      const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 40.75, lng: -73.98 },
        zoom: 12,
        styles: mapStyle,
        mapTypeControl: false, // Optional: Hide map type control
        streetViewControl: false // Optional: Hide street view pegman
      });

      kmlDoc.querySelectorAll('Placemark').forEach(pm => {
        const name = pm.querySelector('name')?.textContent;
        const coords = pm.querySelector('Point > coordinates')?.textContent.trim().split(',');
        if (!name || !coords) return;
        const [lng, lat] = coords.map(Number);
        const sid = pm.querySelector('styleUrl')?.textContent.slice(1);
        const markerOpts = { position: { lat, lng }, map, title: name };
        if (sid && iconMap[sid]) {
          markerOpts.icon = { url: iconMap[sid], scaledSize: new google.maps.Size(30, 30), anchor: new google.maps.Point(15, 30) };
        }
        const marker = new google.maps.Marker(markerOpts);
        const loc = locMap[name] || {};
        const slug = name.toLowerCase().replace(/\W+/g, '-');
        const apiKey = 'AIzaSyBBksh0YwSl7gekcaTX-_xRcBE-Me125rc'; // Use your API key here
        const satelliteViewUrl = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lng}&zoom=18&size=400x200&maptype=satellite&key=${apiKey}`;
        const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        const infoWindowContent = `
          <div class="info-window-content">
            <h3>${name}</h3>
            <img src="${satelliteViewUrl}" alt="Satellite view of ${name}">
            ${loc.description ? `<p>${loc.description}</p>` : ''}
            <p>
              <a href="locations/${slug}/" target="_blank">See More →</a> |
              <a href="${directionsUrl}" target="_blank">Get Directions →</a>
            </p>
          </div>`;
        const infowindow = new google.maps.InfoWindow({ content: infoWindowContent });
        marker.addListener('click', () => infowindow.open(map, marker));
      });
    }
    window.initMap = initMap;
  </script>
</body>
</html>